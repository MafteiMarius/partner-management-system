document.getElementById('partenerForm').addEventListener('submit', function(e) {
  e.preventDefault();

  const cnpValue = document.getElementById('cod').value.trim();

  if (!isValidCNP(cnpValue)) {
    alert("CNP invalid! Verificați că ați introdus corect.");
    document.getElementById('cod').focus();
    return;
  }

  const numeInput = document.getElementById('nume');
  const numeValue = toUpperCaseWords(numeInput.value);
  
  if (!numeValue) {
    alert("Vă rugăm să introduceți numele și prenumele!");
    numeInput.focus();
    return;
  }

  if (/[\";:<>\/\\|=_]/.test(numeInput.value)) {
  alert('Numele conține caractere nepermise.');
  numeInput.focus();
  return;
}
  
  numeInput.value = numeValue;

  const serieInput = document.getElementById('serie');
  if (serieInput.value.trim()) {
    serieInput.value = serieInput.value.trim().toUpperCase();
  }

  if (!orasSelectat) {
  alert('Selectați orașul din listă. Introducerea manuală nu este permisă.');
  orasInput.focus();
  return;
}

  const generatedId = generateIdFromCNP(cnpValue);

  const serieNumarCombinat = formatSerieNumar(
    document.getElementById('serie').value,
    document.getElementById('numar').value
  );

  const data = {
  id: generatedId,
  nume: numeValue,
  codFiscal: cnpValue,
  reg_com: serieNumarCombinat,
  platitorTVA: false,
  oras: document.getElementById('oras').value.trim().toUpperCase(),
  idOras: document.getElementById('idOras').value,
  idJudet: document.getElementById('idJudet').value,
  strada: document.getElementById('strada').value.trim().toUpperCase(),
  numar_strada: document.getElementById('numar_strada').value.trim().toUpperCase(),
  bloc: document.getElementById('bloc').value.trim().toUpperCase() || null,
  scara: document.getElementById('scara').value.trim().toUpperCase() || null,
  etaj: document.getElementById('etaj').value.trim() || null,
  apartament: document.getElementById('apartament').value.trim().toUpperCase() || null,
  telefon: document.getElementById('telefon').value.trim() || null,
  email: document.getElementById('email').value.trim() || null,
};
});

const submitBtn = e.target.querySelector('button[type="submit"]');
if(submitBtn) submitBtn.disabled = true;

console.log("Se trimit datele către server...", data);

fetch('http://192.168.0.185:5000/adauga-partener', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(data)
})
.then(response => {
  if (!response.ok) throw new Error('Eroare rețea sau server');
  return response.json();
})
.then(res => {
  if (res.cod === 0) {
    alert(`✅ Succes! Partenerul "${numeValue}" a fost creat.`);
    document.getElementById('partenerForm').reset();
    orasSelectat = false;
  } else if (res.cod === 4) {
    alert(`⚠️ Atenție: Partenerul "${numeValue}" există deja în baza de date!`);
  } else {
    alert(`❌ Eroare neașteptată (Cod SQL: ${res.cod}).`);
  }
})
.catch(error => {
  console.error('Error:', error);
  alert('❌ Nu s-a putut contacta serverul. Verifică dacă aplicația Python rulează.');
})
.finally(() => {
  if(submitBtn) submitBtn.disabled = false;
});

document.getElementById('numar').addEventListener('input', function() {
  this.value = this.value.replace(/[^a-zA-Z0-9]/g, '');
});

document.getElementById('serie').addEventListener('input', function() {
  this.value = this.value.toUpperCase();
});

document.addEventListener('DOMContentLoaded', function() {
  const tvaContainer = document.getElementById('tvaContainer');
  if (tvaContainer) {
    tvaContainer.style.display = 'none';
  }
  
  const codInput = document.getElementById('cod');
  
  codInput.addEventListener('keypress', function(e) {
    if (!/\d/.test(e.key) && 
        !['Backspace', 'Delete', 'ArrowLeft', 'ArrowRight', 'Tab'].includes(e.key)) {
      e.preventDefault();
    }
  });
  
  codInput.addEventListener('input', function() {
    if (this.value.length > 13) {
      this.value = this.value.slice(0, 13);
    }
  });
});